# 🚀 同値分割法 上級演習・実務レベル

## 📋 このファイルを読む目的
**実際のプロジェクトで即座に活用できる実務レベルの同値分割スキル**を完全習得する

## ⏰ 60分後のあなた
✅ Laravel等の実務レベル演習を完全クリアできる
✅ 複雑な条件の同値分割を体系的に実行できる
✅ 境界値分析との効果的な組み合わせができる
✅ 明日から実プロジェクトで同値分割を活用できる

## 👤 読むべき人
実務で同値分割を使いたい人、プロジェクトの品質を向上させたい人

## 📈 具体的な成果物
- 実務レベル演習4問の完答
- Laravel実装レベルのテストケース設計
- 境界値分析との統合テストケース
- 自分のプロジェクトへの適用計画

---

## 🎯 実務レベル演習の特徴

### 💼 基本演習との違い

| 観点 | 基本演習 | 実務レベル演習 |
|------|----------|---------------|
| **条件数** | 3条件以下 | 5-8条件 |
| **複雑度** | 単純な分岐 | 複雑な依存関係 |
| **暗黙の制約** | 明示的 | 仕様書から推測 |
| **実装連携** | なし | Laravel等と連携 |
| **他技法** | 単独 | 境界値分析と組み合わせ |
| **所要時間** | 10-15分/問 | 30-45分/問 |

### 🔍 実務レベルで求められるスキル

1. **仕様書からの要件抽出**: 明示されていない制約も考慮
2. **複雑な条件の整理**: 依存関係のある条件の分析
3. **実装レベルの理解**: Laravel等のフレームワーク知識
4. **技法の組み合わせ**: 境界値分析・デシジョンテーブルとの連携
5. **優先順位付け**: リスクベースのテストケース選択

---

## 🛠️ 実務演習1: Laravelバリデーション（会員登録フォーム）

### 📋 演習仕様

```php
// app/Http/Requests/RegisterRequest.php
class RegisterRequest extends FormRequest
{
    public function rules()
    {
        return [
            'username' => 'required|string|min:3|max:20|unique:users',
            'email' => 'required|email|max:255|unique:users',
            'password' => 'required|string|min:8|max:30|confirmed',
            'age' => 'required|integer|between:18,65',
            'terms_accepted' => 'required|accepted',
        ];
    }

    public function messages()
    {
        return [
            'username.required' => 'ユーザー名は必須です',
            'username.min' => 'ユーザー名は3文字以上必要です',
            'username.max' => 'ユーザー名は20文字以内です',
            'username.unique' => 'このユーザー名は既に使用されています',
            'email.required' => 'メールアドレスは必須です',
            'email.email' => 'メールアドレスの形式が不正です',
            'email.unique' => 'このメールアドレスは既に登録されています',
            'password.required' => 'パスワードは必須です',
            'password.min' => 'パスワードは8文字以上必要です',
            'password.max' => 'パスワードは30文字以内です',
            'password.confirmed' => 'パスワード確認が一致しません',
            'age.required' => '年齢は必須です',
            'age.between' => '年齢は18-65歳の間で入力してください',
            'terms_accepted.required' => '利用規約への同意が必要です',
        ];
    }
}
```

### 🔍 段階的解法

#### Step 1: フィールドごとの仕様分析

**username フィールド**:
```
制約:
- 必須入力
- 文字列型
- 長さ: 3-20文字
- 既存ユーザーと重複不可

暗黙の制約（推測）:
- 特殊文字の扱い（仕様書要確認）
- 大文字小文字の区別
- 空白文字の扱い
```

**email フィールド**:
```
制約:
- 必須入力
- メールアドレス形式
- 最大255文字
- 既存メールと重複不可

暗黙の制約:
- RFC準拠の形式チェック
- ドメイン部分の検証
```

**password フィールド**:
```
制約:
- 必須入力
- 文字列型
- 長さ: 8-30文字
- 確認パスワードと一致必須

暗黙の制約:
- 文字種制限（英数字記号）
- 強度チェック（実装次第）
```

**age フィールド**:
```
制約:
- 必須入力
- 整数型
- 範囲: 18-65歳

暗黙の制約:
- 負の値の扱い
- 小数の扱い
```

**terms_accepted フィールド**:
```
制約:
- 必須チェック
- 真偽値（accepted）

暗黙の制約:
- チェックボックスONのみ許可
```

#### Step 2: username フィールドの同値分割（詳細）

**有効同値クラス**:
```
EC1: 3-20文字の文字列（新規）
  代表値: "testuser123"（11文字）
```

**無効同値クラス**:
```
EC2: 3文字未満
  代表値: "ab"（2文字）
  期待結果: "ユーザー名は3文字以上必要です"

EC3: 20文字超過
  代表値: "verylongusernameexceeds"（23文字）
  期待結果: "ユーザー名は20文字以内です"

EC4: 未入力
  代表値: ""（空文字）
  期待結果: "ユーザー名は必須です"

EC5: 既存ユーザーと重複
  代表値: "existinguser"（既存のユーザー名）
  期待結果: "このユーザー名は既に使用されています"

EC6: 数値型
  代表値: 12345
  期待結果: "ユーザー名は文字列である必要があります"

EC7: null
  代表値: null
  期待結果: "ユーザー名は必須です"
```

#### Step 3: 全フィールドの同値クラステーブル

| フィールド | EC番号 | 分類 | 代表値 | 期待結果 |
|-----------|--------|------|--------|----------|
| username | EC1 | 有効 | "testuser123" | バリデーション成功 |
| username | EC2 | 無効 | "ab" | 3文字以上エラー |
| username | EC3 | 無効 | "verylongusername123" | 20文字以内エラー |
| username | EC4 | 無効 | "" | 必須エラー |
| username | EC5 | 無効 | "existinguser" | 重複エラー |
| email | EC6 | 有効 | "test@example.com" | バリデーション成功 |
| email | EC7 | 無効 | "invalid-email" | 形式エラー |
| email | EC8 | 無効 | "" | 必須エラー |
| email | EC9 | 無効 | "existing@example.com" | 重複エラー |
| password | EC10 | 有効 | "Password123" | バリデーション成功 |
| password | EC11 | 無効 | "Pass1" | 8文字以上エラー |
| password | EC12 | 無効 | "VeryLongPassword123456789012" | 30文字以内エラー |
| password | EC13 | 無効 | "Password123" (確認不一致) | 確認一致エラー |
| age | EC14 | 有効 | 30 | バリデーション成功 |
| age | EC15 | 無効 | 15 | 18-65歳エラー |
| age | EC16 | 無効 | 70 | 18-65歳エラー |
| age | EC17 | 無効 | "abc" | 整数型エラー |
| terms | EC18 | 有効 | true/1 | バリデーション成功 |
| terms | EC19 | 無効 | false/0 | 同意必須エラー |

### 💡 境界値分析との組み合わせ

#### username の境界値追加
```
同値分割（基本）: 3-20文字 → 代表値 "testuser123"
境界値分析（追加）:
  - 2文字（下限-1）: "ab"
  - 3文字（下限）: "abc"
  - 4文字（下限+1）: "abcd"
  - 19文字（上限-1）: "testusername1234567"
  - 20文字（上限）: "testusername12345678"
  - 21文字（上限+1）: "testusername123456789"
```

### 📝 PHPUnit テストケース実装例

```php
// tests/Feature/RegisterRequestTest.php
class RegisterRequestTest extends TestCase
{
    /** @test */
    public function username_valid_equivalence_class()
    {
        $data = $this->validData(['username' => 'testuser123']);
        $response = $this->post('/register', $data);
        $response->assertSuccessful();
    }

    /** @test */
    public function username_too_short_equivalence_class()
    {
        $data = $this->validData(['username' => 'ab']);
        $response = $this->post('/register', $data);
        $response->assertSessionHasErrors('username');
        $this->assertEquals(
            'ユーザー名は3文字以上必要です',
            session('errors')->first('username')
        );
    }

    /** @test */
    public function username_too_long_equivalence_class()
    {
        $data = $this->validData(['username' => 'verylongusername123']);
        $response = $this->post('/register', $data);
        $response->assertSessionHasErrors('username');
    }

    /** @test */
    public function username_duplicate_equivalence_class()
    {
        User::factory()->create(['username' => 'existinguser']);
        $data = $this->validData(['username' => 'existinguser']);
        $response = $this->post('/register', $data);
        $response->assertSessionHasErrors('username');
    }

    // 境界値分析との組み合わせ
    /** @test */
    public function username_boundary_values()
    {
        // 下限境界
        $this->assertInvalid(['username' => 'ab']);  // 2文字
        $this->assertValid(['username' => 'abc']);    // 3文字
        $this->assertValid(['username' => 'abcd']);   // 4文字

        // 上限境界
        $this->assertValid(['username' => str_repeat('a', 19)]);  // 19文字
        $this->assertValid(['username' => str_repeat('a', 20)]);  // 20文字
        $this->assertInvalid(['username' => str_repeat('a', 21)]); // 21文字
    }

    private function validData($overrides = [])
    {
        return array_merge([
            'username' => 'testuser123',
            'email' => 'test@example.com',
            'password' => 'Password123',
            'password_confirmation' => 'Password123',
            'age' => 30,
            'terms_accepted' => 1,
        ], $overrides);
    }
}
```

---

## 🛠️ 実務演習2: ECサイト商品検索システム

### 📋 演習仕様

```php
// app/Http/Controllers/ProductController.php
class ProductController extends Controller
{
    public function search(Request $request)
    {
        $validated = $request->validate([
            'keyword' => 'nullable|string|max:100',
            'category_id' => 'nullable|integer|exists:categories,id',
            'price_min' => 'nullable|integer|min:0|max:1000000',
            'price_max' => 'nullable|integer|min:0|max:1000000',
            'in_stock_only' => 'nullable|boolean',
            'sort_by' => 'nullable|in:price_asc,price_desc,name_asc,newest',
        ]);

        // 追加のビジネスロジック検証
        if (isset($validated['price_min']) && isset($validated['price_max'])) {
            if ($validated['price_min'] > $validated['price_max']) {
                return back()->withErrors(['price_min' => '最小価格は最大価格以下である必要があります']);
            }
        }

        return view('products.index', [
            'products' => $this->searchProducts($validated)
        ]);
    }
}
```

### 🔍 複雑な条件の整理

#### 条件分析
```
1. keyword: オプション、文字列、最大100文字
2. category_id: オプション、整数、categories テーブル存在確認
3. price_min: オプション、整数、0-1,000,000
4. price_max: オプション、整数、0-1,000,000
5. in_stock_only: オプション、真偽値
6. sort_by: オプション、4つの選択肢

複雑な依存関係:
- price_min と price_max: min <= max の制約
- オプション項目: 全て未指定でも動作する
```

### 📝 自分で解いてみましょう

#### 課題
各フィールドの同値クラスを特定し、テストケース表を作成してください。

**特に注意すべき点**:
1. オプション項目（未指定も有効）
2. price_min と price_max の依存関係
3. exists バリデーション（DBに存在するID）

### ✅ 解答例

#### keyword フィールド
```
EC1（有効）: null（未指定） → 全商品検索
EC2（有効）: 1-100文字の文字列 → キーワード検索実行
EC3（無効）: 100文字超過 → エラー
EC4（無効）: 配列等の非文字列 → エラー
```

#### category_id フィールド
```
EC5（有効）: null（未指定） → カテゴリ絞込なし
EC6（有効）: 存在するカテゴリID → カテゴリ絞込実行
EC7（無効）: 存在しないID → エラー
EC8（無効）: 非整数 → エラー
EC9（無効）: 負の値 → エラー
```

#### price_min / price_max フィールド（依存関係あり）
```
EC10（有効）: 両方null → 価格絞込なし
EC11（有効）: min=5000, max=null → 5000円以上
EC12（有効）: min=null, max=10000 → 10000円以下
EC13（有効）: min=5000, max=10000 (min≤max) → 5000-10000円
EC14（無効）: min=10000, max=5000 (min>max) → エラー
EC15（無効）: min=-100 → エラー
EC16（無効）: max=1000001 → エラー
```

#### 主要テストケース表
| ID | keyword | category | price_min | price_max | 期待結果 |
|----|---------|----------|-----------|-----------|----------|
| TC001 | null | null | null | null | 全商品表示 |
| TC002 | "ノート" | 1 | 500 | 2000 | 絞込検索成功 |
| TC003 | str(101文字) | null | null | null | keyword長さエラー |
| TC004 | null | 999 | null | null | 存在しないIDエラー |
| TC005 | null | null | 10000 | 5000 | min>maxエラー |
| TC006 | null | null | -100 | null | 負の値エラー |
| TC007 | null | null | null | 1000001 | 上限超過エラー |

---

## 🛠️ 実務演習3: APIリクエスト検証（ユーザー更新API）

### 📋 演習仕様

```php
// app/Http/Controllers/Api/UserController.php
class UserController extends Controller
{
    /**
     * @OA\Put(
     *   path="/api/users/{id}",
     *   @OA\Parameter(name="id", in="path", required=true),
     *   @OA\RequestBody(
     *     @OA\JsonContent(
     *       @OA\Property(property="name", type="string", minLength=2, maxLength=50),
     *       @OA\Property(property="email", type="string", format="email"),
     *       @OA\Property(property="role", type="string", enum={"user","admin","moderator"}),
     *       @OA\Property(property="status", type="string", enum={"active","inactive","suspended"}),
     *     )
     *   )
     * )
     */
    public function update(Request $request, $id)
    {
        $user = User::findOrFail($id);

        $validated = $request->validate([
            'name' => 'sometimes|string|min:2|max:50',
            'email' => 'sometimes|email|unique:users,email,' . $user->id,
            'role' => 'sometimes|in:user,admin,moderator',
            'status' => 'sometimes|in:active,inactive,suspended',
        ]);

        // ビジネスルール: adminユーザーは自分自身をinactiveにできない
        if (auth()->id() === $user->id && 
            isset($validated['status']) && 
            $validated['status'] === 'inactive' &&
            $user->role === 'admin') {
            return response()->json([
                'message' => '管理者は自分自身を無効化できません'
            ], 422);
        }

        $user->update($validated);
        return new UserResource($user);
    }
}
```

### 🔍 API特有の考慮事項

#### 1. PATCH vs PUT の違い
```
PUT: 全フィールド送信
PATCH: 更新したいフィールドのみ送信（sometimes）

今回はsometimesルールなので、部分更新（PATCH的）
```

#### 2. APIレスポンス
```
成功: 200 OK + UserResource
バリデーションエラー: 422 Unprocessable Entity
存在しないID: 404 Not Found
ビジネスルールエラー: 422 Unprocessable Entity
```

### 📝 同値クラス設計

#### name フィールド（オプション）
```
EC1: 未指定（null） → 更新しない（有効）
EC2: 2-50文字 → 更新成功（有効）
EC3: 2文字未満 → エラー（無効）
EC4: 50文字超過 → エラー（無効）
```

#### role フィールド（列挙型）
```
EC5: 未指定 → 更新しない（有効）
EC6: "user" → 更新成功（有効）
EC7: "admin" → 更新成功（有効）
EC8: "moderator" → 更新成功（有効）
EC9: "superuser" → エラー（無効・範囲外）
EC10: 123 → エラー（無効・型不一致）
```

#### 複合条件（ビジネスルール）
```
EC11: admin自身 + status=inactive → エラー（ビジネスルール違反）
EC12: admin自身 + status=active → 成功
EC13: 他ユーザー + status=inactive → 成功
```

### 📋 APIテストケース実装例

```php
// tests/Feature/Api/UserControllerTest.php
class UserControllerTest extends TestCase
{
    use RefreshDatabase;

    /** @test */
    public function name_valid_equivalence_class()
    {
        $user = User::factory()->create();
        $response = $this->putJson("/api/users/{$user->id}", [
            'name' => 'Updated Name'
        ]);
        $response->assertOk();
        $this->assertEquals('Updated Name', $user->fresh()->name);
    }

    /** @test */
    public function name_too_short_equivalence_class()
    {
        $user = User::factory()->create();
        $response = $this->putJson("/api/users/{$user->id}", [
            'name' => 'A'
        ]);
        $response->assertStatus(422);
        $response->assertJsonValidationErrors('name');
    }

    /** @test */
    public function role_valid_enum_equivalence_classes()
    {
        $user = User::factory()->create();
        
        foreach (['user', 'admin', 'moderator'] as $role) {
            $response = $this->putJson("/api/users/{$user->id}", [
                'role' => $role
            ]);
            $response->assertOk();
        }
    }

    /** @test */
    public function role_invalid_enum_equivalence_class()
    {
        $user = User::factory()->create();
        $response = $this->putJson("/api/users/{$user->id}", [
            'role' => 'superuser'
        ]);
        $response->assertStatus(422);
    }

    /** @test */
    public function admin_cannot_deactivate_self_business_rule()
    {
        $admin = User::factory()->create(['role' => 'admin']);
        $this->actingAs($admin);
        
        $response = $this->putJson("/api/users/{$admin->id}", [
            'status' => 'inactive'
        ]);
        
        $response->assertStatus(422);
        $response->assertJson([
            'message' => '管理者は自分自身を無効化できません'
        ]);
    }
}
```

---

## 🛠️ 実務演習4: 予約システム（複雑な日時条件）

### 📋 演習仕様

```php
// app/Http/Requests/CreateReservationRequest.php
class CreateReservationRequest extends FormRequest
{
    public function rules()
    {
        return [
            'service_id' => 'required|exists:services,id',
            'reservation_date' => 'required|date|after:today',
            'start_time' => 'required|date_format:H:i',
            'duration' => 'required|integer|in:30,60,90,120',
            'number_of_people' => 'required|integer|between:1,10',
        ];
    }

    public function withValidator($validator)
    {
        $validator->after(function ($validator) {
            // ビジネスルール1: 営業時間チェック（9:00-21:00）
            $startTime = Carbon::createFromFormat('H:i', $this->start_time);
            $endTime = $startTime->copy()->addMinutes($this->duration);
            
            if ($startTime->lt(Carbon::createFromFormat('H:i', '09:00')) ||
                $endTime->gt(Carbon::createFromFormat('H:i', '21:00'))) {
                $validator->errors()->add('start_time', '営業時間外です（9:00-21:00）');
            }

            // ビジネスルール2: 予約は3ヶ月先まで
            if ($this->reservation_date) {
                $reservationDate = Carbon::parse($this->reservation_date);
                if ($reservationDate->gt(now()->addMonths(3))) {
                    $validator->errors()->add('reservation_date', '予約は3ヶ月先までです');
                }
            }

            // ビジネスルール3: 時間枠の重複チェック（簡略化）
            // 実際にはDBチェックが必要
        });
    }
}
```

### 📝 この演習のポイント

#### 複雑な条件
1. **日時の複合条件**: 日付 + 時刻 + 時間
2. **ビジネスルール**: 営業時間、予約期間制限
3. **列挙型**: duration（4つの選択肢）
4. **依存関係**: start_time + duration → end_time

### 🔍 同値クラス設計（主要項目）

#### reservation_date
```
EC1: 明日 → 有効
EC2: 1週間後 → 有効
EC3: 3ヶ月後 → 有効
EC4: 今日 → 無効（after:today）
EC5: 昨日 → 無効（過去）
EC6: 3ヶ月+1日後 → 無効（期間超過）
EC7: "2025-13-01" → 無効（不正な日付）
```

#### start_time + duration（複合条件）
```
EC8: start=10:00, duration=60 → end=11:00（営業時間内・有効）
EC9: start=08:00, duration=60 → end=09:00（開始時刻が営業前・無効）
EC10: start=20:30, duration=60 → end=21:30（終了時刻が営業後・無効）
EC11: start=20:00, duration=60 → end=21:00（境界・有効）
EC12: start=09:00, duration=120 → end=11:00（長時間・有効）
```

#### duration（列挙型）
```
EC13: 30 → 有効
EC14: 60 → 有効
EC15: 90 → 有効
EC16: 120 → 有効
EC17: 45 → 無効（選択肢外）
EC18: 150 → 無効（選択肢外）
```

---

## 📊 実務レベル演習のまとめ

### ✅ 習得すべきスキル確認

以下のスキルを4つの演習を通じて習得しましたか？

- [ ] **Laravel実装レベル**: Formリクエスト・バリデーションルールの理解
- [ ] **複雑な条件整理**: 5-8条件の体系的な分析
- [ ] **依存関係の処理**: price_min/max等の条件間関係
- [ ] **暗黙の制約**: 仕様書に明記されていない制約の考慮
- [ ] **ビジネスルール**: 実装ロジックに埋め込まれたルール
- [ ] **技法の組み合わせ**: 境界値分析との統合
- [ ] **APIテスト**: RESTful API特有の考慮事項
- [ ] **テストコード実装**: PHPUnitでの実装パターン

### 🎯 実務適用レベル判定

**8項目中6項目以上クリア**: 実務適用レベル到達 ✅  
**5項目以下**: 演習を再度実施または`05_追加演習`で補強推奨

---

## 📝 学習記録テンプレート

```markdown
【同値分割 上級演習・実務レベル】
日時: 2025/10/14
学習時間: 60分

## 完了した演習
- [ ] 演習1: Laravel会員登録（所要時間: __分）
- [ ] 演習2: 商品検索システム（所要時間: __分）
- [ ] 演習3: API更新検証（所要時間: __分）
- [ ] 演習4: 予約システム（所要時間: __分）

## 理解できた内容
- 複雑な条件の整理方法
- [その他]

## 困難だった点
- ビジネスルールの抽出
- [その他]

## 実務で適用したい場面
- 現在のプロジェクトの〇〇機能
- [その他]

## 次のステップ
- 実プロジェクトでの適用
- 境界値分析との組み合わせ強化
- [その他]
```

---

*実務レベル演習完了！実際のプロジェクトで同値分割を活用開始*  
*次は`06_実務適用ガイド.md`で組織適用のノウハウを習得*
